
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxwYXRoIGQ9Ik00Ljc4MjE2IDEyLjAwMDFDNC43ODIxNiAxMS4yMTMgNS4wOTQ2NiAxMC40NTcyIDUuNjYwMTYgOS44OTE3NUw5Ljg5MTY2IDUuNjYwMjVDMTAuNDU3MiA1LjA5NDc1IDExLjIxMjkgNC43ODIyNSAxMiA0Ljc4MjI1QzEyLjc4NyA0Ljc4MjI1IDEzLjU0MjggNS4wOTQ3NSAxNC4xMDgzIDUuNjYwMjVMMTguMzM5OCA5Ljg5MTc1QzE5LjQ3MDggMTEuMDIyOCAxOS40NzA4IDEyLjk3NzIgMTguMzM5OCAxNC4xMDg0QzE3LjIwODcgMTUuMjM5MyAxNS4yNTQzIDE1LjIzOTMgMTQuMTA4MyAxNC4xMDg0TDEyLjAwMDIgMTIuMDAwMkw5Ljg5MTY2IDE0LjExMDgzQzguNzYwNjYgMTUuMjM5MyA2LjgwNjE2IDE1LjIzOTMgNS42NzUxNiAxNC4xMDg0QzUuMTAxMTYgMTMuNTM4MyA0Ljc4MjE2IDEyLjc4NzYgNC43ODIxNiAxMi4wMDAxWiIgZmlsbD0idXJsKCNwYWludDBfbGluZWFyXzFfNCkiLz4KICAgIDxwYXRoIGQ9Ik0xMi4wMDAyIDE5LjIxNzhDMTIuNzg3MiAxOS4yMTc4IDEzLjU0MjkgMTguOTA1MTEgMTQuMTA4MyAxOC4zMzOThMMTguMzM5OSAxNC4xMDgzQzE5LjQ3MDkgMTIuOTc3MyAxOS40NzA5IDExLjAyMjggMTguMzM5OSAxMC44OTE4TDE0LjEwODQgNS42NjAzQzEzLjU0MjkgNS4wOTQ4IDEyLjc4NzIgNC43ODIzIDEyLjAwMDIgNC43ODIzQzExLjIxMzIgNC43ODIzIDEwLjQ1NzQgNS4wOTQ4IDkuODkxOSA1LjY2MDNMNi42NjA0IDkuODkxOEM0LjUyOTQgMTEuMDIyOCAzLjUyOTQgMTIuOTc3MyA1LjY2MDQgMTQuMTA4M0w5Ljg5MTkgMTguMzM5OEMxMC40NTc0IDE4LjkwNTMgMTEuMjEzMiAxOS4yMTc4IDEyLjAwMDIgMTkuMjE3OFpNMTIuMDAwMiAxNi41Njc4TDcuNDMyOSAxMi4wMDA1TDEyLjAwMDIgNy40MzMzTDE2LjU2NzQgMTIuMDAwNUwxMi4wMDAyIDE2LjU2NzhOIiBmaWxsPSJ1cmwoI3BhaWVudDFfbGluZWFyXzFfNCkiLz4KICAgIDxkZWZzPgogICAgICAgIDxsaW5lYXJHcmFkaWVudCBpZD0icGFpbnQwX2xpbmVhcl8xXzQiIHgxPSIxMiIgeTE9IjQuNzgyMjUiIHgyPSIxMiIgeTI9IjE1LjIzOTMiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIj4KICAgICAgICAgICAgPHN0b3Agc3RvcC1jb2xvcj0iIzlFRThGRiIvPgogICAgICAgICAgICA8c3RvcCBvZmZzZXQ9IjEiIHN0b3AtY29sb3I9IiMwMDcyRkYiLz4KICAgICAgICA8L2xpbmVhckdyYWRpZW50PgogICAgICAgIDxsaW5lYXJHcmFkaWVudCBpZD0icGFpbnQxX2xpbmVhcl8xXzQiIHgxPSIxMiIgeTE9IjQuNzgyMyIgeDI9IjEyIiB5Mj0iMTkuMjE3OCIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiPgogICAgICAgICAgICA8c3RvcCBvZmZzZXQ9IjAuMTc3NTE1IiBzdG9wLWNvbG9yPSIjRkZFNzdGIi8+CgkgICAgICAgIDxzdG9wIG9mZnNldD0iMC4zNTkzNzUiIHN0b3AtY29sb3I9IiNGRkM2QTUiLz4KCSAgICAgICAgPHN0b3Agb2Zmc2V0PSIwLjYyNSIgc3RvcC1jb2xvcj0iI0ZGNkQzMiIvPgoJICAgICAgICA8c3RvcCBvZmZzZXQ9IjEiIHN0b3AtY29sb3I9IiNGRjU2MTkiLz4KICAgICAgICA8L2xpbmVhckdyYWRpZW50PgogICAgPC9kZWZzPgo8L3N2Zz4=">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gemini TTS Showcase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.3.1",
          "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
          "@google/genai": "https://esm.sh/@google/genai@0.14.0"
        }
      }
    </script>
  <link rel="stylesheet" href="/index.css">
</head>
  <body class="bg-gray-900 text-white">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
      import React, { useState, useCallback, useRef, useEffect } from 'react';
      import ReactDOM from 'react-dom/client';
      import { GoogleGenAI, Modality } from "@google/genai";

      // --- Start of types.ts ---
      const ALL_VOICE_NAMES = [
        'Achernar', 'Achird', 'Algenib', 'Algieba', 'Alnilam', 'Aoede', 'Autonoe', 'Callirrhoe',
        'Charon', 'Despina', 'Enceladus', 'Erinome', 'Fenrir', 'Gacrux', 'Iapetus', 'Kore',
        'Laomedeia', 'Leda', 'Orus', 'Puck', 'Pulcherrima', 'Rasalgethi', 'Sadachbia', 'Sadaltager',
        'Schedar', 'Sulafat', 'Umbriel', 'Vindemiatrix', 'Zephyr', 'Zubenelgenubi'
      ];

      const PREBUILT_VOICES = ALL_VOICE_NAMES
        .sort((a, b) => a.localeCompare(b))
        .map(name => ({ name }));

      // --- Start of utils/audioUtils.ts ---
      const SAMPLE_RATE = 24000;
      const NUM_CHANNELS = 1;
      const BIT_DEPTH = 16; 

      let audioContext = null;

      const getAudioContext = () => {
        if (!audioContext || audioContext.state === 'closed') {
          audioContext = new (window.AudioContext || window.webkitAudioContext)({
            sampleRate: SAMPLE_RATE,
          });
        }
        if (audioContext.state === 'suspended') {
          audioContext.resume();
        }
        return audioContext;
      };

      function decode(base64) {
        const binaryString = atob(base64);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes;
      }

      async function createAudioBuffer(base64Audio) {
        const ctx = getAudioContext();
        const decodedBytes = decode(base64Audio);
        
        const dataInt16 = new Int16Array(decodedBytes.buffer);
        const frameCount = dataInt16.length / NUM_CHANNELS;
        const buffer = ctx.createBuffer(NUM_CHANNELS, frameCount, SAMPLE_RATE);

        for (let channel = 0; channel < NUM_CHANNELS; channel++) {
          const channelData = buffer.getChannelData(channel);
          for (let i = 0; i < frameCount; i++) {
            channelData[i] = dataInt16[i * NUM_CHANNELS + channel] / 32768.0;
          }
        }
        return buffer;
      }

      const createWavBlob = (base64Audio) => {
          const pcmData = decode(base64Audio);
          const header = new ArrayBuffer(44);
          const view = new DataView(header);

          const writeString = (offset, str) => {
              for (let i = 0; i < str.length; i++) {
                  view.setUint8(offset + i, str.charCodeAt(i));
              }
          };

          const pcmDataLength = pcmData.length;
          const fileSize = pcmDataLength + 36;
          const blockAlign = (NUM_CHANNELS * BIT_DEPTH) / 8;
          const byteRate = SAMPLE_RATE * blockAlign;

          writeString(0, 'RIFF');
          view.setUint32(4, fileSize, true);
          writeString(8, 'WAVE');
          writeString(12, 'fmt ');
          view.setUint32(16, 16, true);
          view.setUint16(20, 1, true);
          view.setUint16(22, NUM_CHANNELS, true);
          view.setUint32(24, SAMPLE_RATE, true);
          view.setUint32(28, byteRate, true);
          view.setUint16(32, blockAlign, true);
          view.setUint16(34, BIT_DEPTH, true);
          writeString(36, 'data');
          view.setUint32(40, pcmDataLength, true);

          return new Blob([header, pcmData], { type: 'audio/wav' });
      };

      // --- Start of services/geminiService.ts ---
      const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
      const model = "gemini-2.5-flash-preview-tts";

      const generateSpeech = async (text, voiceName, pitch, speakingRate, volumeGainDb) => {
        try {
          const response = await ai.models.generateContent({
            model: model,
            contents: [{ parts: [{ text: text }] }],
            config: {
              responseModalities: [Modality.AUDIO],
              speechConfig: {
                voiceConfig: {
                  prebuiltVoiceConfig: { voiceName: voiceName },
                  pitch: pitch,
                  speakingRate: speakingRate,
                  volumeGainDb: volumeGainDb,
                },
              },
            },
          });

          const base64Audio = response.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;

          if (!base64Audio) {
            throw new Error("API response did not contain audio data.");
          }
          
          return base64Audio;
        } catch (error) {
          console.error(`Error generating speech:`, error);
          if (error instanceof Error) {
              throw new Error(`Failed to generate audio: ${error.message}`);
          }
          throw new Error("An unknown error occurred while generating audio.");
        }
      };

      // --- Start of components/Spinner.tsx ---
      const Spinner = () => (
        <svg
          className="animate-spin h-5 w-5 text-white"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle
            className="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            strokeWidth="4"
          ></circle>
          <path
            className="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
      );
      
      // --- Start of components/icons.tsx ---
      const PasteIcon = (props) => (
        <svg 
          xmlns="http://www.w3.org/2000/svg" 
          className="h-5 w-5" 
          fill="none" 
          viewBox="0 0 24 24" 
          stroke="currentColor" 
          strokeWidth={2}
          {...props}
          >
          <path 
            strokeLinecap="round" 
            strokeLinejoin="round" 
            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" 
          />
        </svg>
      );
      
      const DownloadIcon = (props) => (
        <svg 
          xmlns="http://www.w3.org/2000/svg" 
          className="h-6 w-6" 
          fill="none" 
          viewBox="0 0 24 24" 
          stroke="currentColor" 
          strokeWidth={2}
          {...props}
        >
          <path 
            strokeLinecap="round" 
            strokeLinejoin="round" 
            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" 
          />
        </svg>
      );

      const CloseIcon = (props) => (
          <svg 
            xmlns="http://www.w3.org/2000/svg" 
            className="h-5 w-5" 
            fill="none" 
            viewBox="0 0 24 24" 
            stroke="currentColor" 
            strokeWidth={2.5}
            {...props}
          >
            <path 
              strokeLinecap="round" 
              strokeLinejoin="round" 
              d="M6 18L18 6M6 6l12 12" 
            />
          </svg>
        );

      const PlayIcon = (props) => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
            className="h-5 w-5"
            {...props}
          >
            <path
              fillRule="evenodd"
              d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.648c1.295.748 1.295 2.536 0 3.284L7.279 20.99c-1.25.72-2.779-.217-2.779-1.643V5.653z"
              clipRule="evenodd"
            />
          </svg>
        );

      const StopIcon = (props) => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="currentColor"
          className="h-5 w-5"
          {...props}
        >
          <path
            fillRule="evenodd"
            d="M4.5 7.5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-9a3 3 0 01-3-3v-9z"
            clipRule="evenodd"
          />
        </svg>
      );

      const RewindIcon = (props) => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="currentColor"
          className="h-6 w-6"
          {...props}
        >
          <path
            fillRule="evenodd"
            d="M9.53 2.47a.75.75 0 010 1.06L4.81 8.25H15a6.75 6.75 0 010 13.5h-3a.75.75 0 010-1.5h3a5.25 5.25 0 100-10.5H4.81l4.72 4.72a.75.75 0 11-1.06 1.06l-6-6a.75.75 0 010-1.06l6-6a.75.75 0 011.06 0z"
            clipRule="evenodd"
          />
        </svg>
      );

      const ForwardIcon = (props) => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="currentColor"
          className="h-6 w-6"
          {...props}
        >
          <path
            fillRule="evenodd"
            d="M14.47 2.47a.75.75 0 011.06 0l6 6a.75.75 0 010 1.06l-6 6a.75.75 0 11-1.06-1.06L19.19 8.25H9a6.75 6.75 0 000 13.5h3a.75.75 0 010 1.5H9a5.25 5.25 0 010-10.5h10.19l-4.72-4.72a.75.75 0 010-1.06z"
            clipRule="evenodd"
          />
        </svg>
      );
      
      const GeminiLogo = (props) => (
          <svg 
              width="24" 
              height="24" 
              viewBox="0 0 24 24" 
              fill="none" 
              xmlns="http://www.w3.org/2000/svg"
              className="h-8 w-8"
              {...props}
          >
            <path d="M4.78216 12.0001C4.78216 11.213 5.09466 10.4572 5.66016 9.89175L9.89166 5.66025C10.4572 5.09475 11.2129 4.78225 12 4.78225C12.787 4.78225 13.5428 5.09475 14.1083 5.66025L18.3398 9.89175C19.4708 11.0228 19.4708 12.9772 18.3398 14.1083C17.2087 15.2393 15.2543 15.2393 14.1083 14.1083L12.0002 12.0002L9.89166 14.1083C8.76066 15.2393 6.80616 15.2393 5.67516 14.1084C5.10116 13.5383 4.78216 12.7876 4.78216 12.0001Z" fill="url(#paint0_linear_1_4)"/>
            <path d="M12.0002 19.2178C12.7872 19.2178 13.5429 18.9053 14.1083 18.3398L18.3399 14.1083C19.4709 12.9773 19.4709 11.0228 18.3399 9.8918L14.1084 5.6603C13.5429 5.0948 12.7872 4.7823 12.0002 4.7823C11.2132 4.7823 10.4574 5.0948 9.8919 5.6603L5.6604 9.8918C4.5294 11.0228 4.5294 12.9773 5.6604 14.1083L9.8919 18.3398C10.4574 18.9053 11.2132 19.2178 12.0002 19.2178ZM12.0002 16.5678L7.4329 12.0005L12.0002 7.4333L16.5674 12.0005L12.0002 16.5678Z" fill="url(#paint1_linear_1_4)"/>
            <defs>
                <linearGradient id="paint0_linear_1_4" x1="12" y1="4.78225" x2="12" y2="15.2393" gradientUnits="userSpaceOnUse">
                    <stop stopColor="#99E8FF"/>
                    <stop offset="1" stopColor="#0072FF"/>
                </linearGradient>
                <linearGradient id="paint1_linear_1_4" x1="12" y1="4.7823" x2="12" y2="19.2178" gradientUnits="userSpaceOnUse">
                    <stop offset="0.177515" stopColor="#FFE57F"/>
                    <stop offset="0.359375" stopColor="#FFC6A5"/>
                    <stop offset="0.625" stopColor="#FF6D32"/>
                    <stop offset="1" stopColor="#FF5619"/>
                </linearGradient>
            </defs>
        </svg>
      );
      
      // --- Start of App.tsx ---
      const App = () => {
        const [text, setText] = useState('Hello! I am a friendly AI assistant powered by Google Gemini. Type something here and I will read it for you.');
        const [selectedVoice, setSelectedVoice] = useState(PREBUILT_VOICES[0]);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState(null);
        const [generatedAudio, setGeneratedAudio] = useState(null);
        const [previewingVoice, setPreviewingVoice] = useState(null);
        
        const [pitch, setPitch] = useState(0.0);
        const [speakingRate, setSpeakingRate] = useState(1.0);
        const [volumeGain, setVolumeGain] = useState(0.0);
        const [stylePrompt, setStylePrompt] = useState('');

        // Audio player state
        const [audioBuffer, setAudioBuffer] = useState(null);
        const [audioSource, setAudioSource] = useState(null);
        const [isPlaying, setIsPlaying] = useState(false);
        const [playbackTime, setPlaybackTime] = useState(0);
        const [duration, setDuration] = useState(0);

        const animationFrameRef = useRef();
        const audioContextRef = useRef(getAudioContext());
        
        const STYLE_PRESETS = [
          { name: 'Cheerfully', prompt: 'Say this cheerfully' },
          { name: 'Sadly', prompt: 'Say this sadly' },
          { name: 'Angrily', prompt: 'Say this angrily' },
          { name: 'Emotionally', prompt: 'Say this emotionally' },
        ];

        const stopPlayback = useCallback(() => {
          if (audioSource) {
            audioSource.onended = null;
            try {
              audioSource.stop();
            } catch (e) {
              // Ignore errors from stopping an already-stopped source
            }
            setAudioSource(null);
          }
          if (animationFrameRef.current) {
            cancelAnimationFrame(animationFrameRef.current);
            animationFrameRef.current = undefined;
          }
          setIsPlaying(false);
        }, [audioSource]);

        const startPlayback = useCallback((offset = 0) => {
          if (!audioBuffer) return;
          
          stopPlayback(); // Stop any existing playback first
          
          const source = audioContextRef.current.createBufferSource();
          source.buffer = audioBuffer;
          source.connect(audioContextRef.current.destination);
          
          const startTime = audioContextRef.current.currentTime - offset;
          source.start(0, offset);
          
          setAudioSource(source);
          setIsPlaying(true);
          setPlaybackTime(offset);

          source.onended = () => {
            stopPlayback();
            setPlaybackTime(0); // Reset to start
          };

          const animationLoop = () => {
              const elapsedTime = audioContextRef.current.currentTime - startTime;
              if (elapsedTime <= duration) {
                  setPlaybackTime(elapsedTime);
                  animationFrameRef.current = requestAnimationFrame(animationLoop);
              } else {
                  stopPlayback();
                  setPlaybackTime(0);
              }
          };
          animationFrameRef.current = requestAnimationFrame(animationLoop);

        }, [audioBuffer, duration, stopPlayback]);

        useEffect(() => {
          return () => stopPlayback();
        }, [stopPlayback]);
          
        const handleGenerate = useCallback(async () => {
          if (!text.trim() || loading || previewingVoice) return;

          setLoading(true);
          setError(null);
          stopPlayback();
          setGeneratedAudio(null);
          setAudioBuffer(null);
          setPlaybackTime(0);
          setDuration(0);

          try {
            const fullText = stylePrompt.trim() ? `${stylePrompt.trim()}: ${text}` : text;
            const base64Audio = await generateSpeech(fullText, selectedVoice.name, pitch, speakingRate, volumeGain);
            if (base64Audio) {
              setGeneratedAudio(base64Audio);
              const buffer = await createAudioBuffer(base64Audio);
              setAudioBuffer(buffer);
              setDuration(buffer.duration);
            } else {
              throw new Error('Received empty audio data from the API.');
            }
          } catch (err) {
            console.error('TTS Generation Error:', err);
            setError(err instanceof Error ? err.message : 'An unknown error occurred.');
          } finally {
            setLoading(false);
          }
        }, [text, selectedVoice, loading, previewingVoice, stopPlayback, pitch, speakingRate, volumeGain, stylePrompt]);

        const handleTogglePlay = useCallback(() => {
          if (isPlaying) {
            stopPlayback();
            setPlaybackTime(0); // Reset on manual stop
          } else {
            startPlayback(0); // Always play from start
          }
        }, [isPlaying, startPlayback, stopPlayback]);

        const handleSeek = useCallback((amount) => {
          if (!duration) return;
          const newTime = Math.max(0, Math.min(duration, playbackTime + amount));
          startPlayback(newTime);
        }, [duration, playbackTime, startPlayback]);

     
        const handlePreviewVoice = useCallback(async (voiceToPreview) => {
          if (previewingVoice || loading) return;

          setPreviewingVoice(voiceToPreview.name);
          setError(null);
          const previewText = "This is a preview of the selected voice.";
          const fullPreviewText = stylePrompt.trim() ? `${stylePrompt.trim()}: ${previewText}` : previewText;

          try {
              const base64Audio = await generateSpeech(fullPreviewText, voiceToPreview.name, pitch, speakingRate, volumeGain);
              if (base64Audio) {
                  const buffer = await createAudioBuffer(base64Audio);
                  const source = audioContextRef.current.createBufferSource();
                  source.buffer = buffer;
                  source.connect(audioContextRef.current.destination);
                  source.start();
                  source.onended = () => {
                    setPreviewingVoice(null);
                  }
              } else {
                throw new Error('Received empty audio data for preview.');
              }
          } catch (err) {
            console.error('TTS Preview Error:', err);
            setError(err instanceof Error ? err.message : 'An unknown error occurred during preview.');
            setPreviewingVoice(null);
          }
        }, [previewingVoice, loading, pitch, speakingRate, volumeGain, stylePrompt]);
        
        const handleDownload = useCallback(() => {
          if (!generatedAudio) return;

          try {
            const wavBlob = createWavBlob(generatedAudio);
            const url = URL.createObjectURL(wavBlob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `gemini-tts-${selectedVoice.name.toLowerCase()}-${Date.now()}.wav`; 
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            a.remove();
          } catch (err) {
            console.error('Download Error:', err);
            setError(err instanceof Error ? err.message : 'Failed to prepare audio for download.');
          }
        }, [generatedAudio, selectedVoice]);
        
        const handlePaste = useCallback(async () => {
          if (navigator.clipboard) {
            try {
              const clipboardText = await navigator.clipboard.readText();
              setText(clipboardText);
            } catch (err) {
              console.error('Failed to read clipboard contents: ', err);
              setError('Could not paste text from clipboard.');
            }
          }
        }, []);

        const formatTime = (seconds) => {
          const minutes = Math.floor(seconds / 60);
          const secs = Math.floor(seconds % 60);
          return `${minutes}:${secs.toString().padStart(2, '0')}`;
        };

        const isBusy = loading || !!previewingVoice;

        return (
          <div className="min-h-screen bg-gray-900 text-gray-100 flex flex-col items-center justify-center p-4 font-sans">
            <div className="w-full max-w-2xl mx-auto">
              <header className="text-center mb-8">
                <div className="flex items-center justify-center gap-4 mb-2">
                  <GeminiLogo className="w-12 h-12" />
                  <h1 className="text-4xl md:text-5xl font-bold tracking-tight bg-gradient-to-r from-blue-400 to-purple-500 text-transparent bg-clip-text">
                    Gemini Text-to-Speech
                  </h1>
                </div>
                <p className="text-gray-400">Bring your text to life with generative AI voices.</p>
              </header>

              <main className="bg-gray-800/50 backdrop-blur-sm rounded-2xl shadow-2xl p-6 md:p-8 border border-gray-700">
                <div className="space-y-6">
                  <div>
                    <label htmlFor="text-input" className="block text-sm font-medium text-gray-300 mb-2">
                      Enter Text
                    </label>
                    <div className="relative">
                      <textarea
                        id="text-input"
                        value={text}
                        onChange={(e) => setText(e.target.value)}
                        placeholder="Type something to say..."
                        className="w-full h-40 p-4 pr-20 bg-gray-900 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-shadow duration-200 resize-none text-gray-200"
                        disabled={isBusy}
                        aria-label="Text to be converted to speech"
                      />
                      <div className="absolute top-3 right-3 flex items-center gap-2">
                        {!isBusy && (
                          <button
                            onClick={handlePaste}
                            className="text-gray-400 hover:text-white transition-colors"
                            aria-label="Paste text from clipboard"
                          >
                            <PasteIcon />
                          </button>
                        )}
                        {text && !isBusy && (
                          <button
                            onClick={() => setText('')}
                            className="text-gray-400 hover:text-white transition-colors"
                            aria-label="Clear text"
                          >
                            <CloseIcon />
                          </button>
                        )}
                      </div>
                    </div>
                  </div>

                  <div>
                    <h3 className="text-sm font-medium text-gray-300 mb-3">Choose a Voice</h3>
                    <div className="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-5 gap-3">
                      {PREBUILT_VOICES.map((voice) => (
                        <div key={voice.name} className="relative">
                          <button
                            onClick={() => setSelectedVoice(voice)}
                            disabled={isBusy}
                            className={`w-full text-left p-3 pr-10 rounded-lg border-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-purple-500
                              ${selectedVoice.name === voice.name ? 'bg-purple-600 border-purple-500 shadow-lg' : 'bg-gray-700 border-gray-600 hover:bg-gray-600'}
                              ${isBusy ? 'cursor-not-allowed opacity-60' : ''}`}
                            aria-pressed={selectedVoice.name === voice.name}
                          >
                            <span className="font-semibold text-white text-sm">{voice.name}</span>
                          </button>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              handlePreviewVoice(voice);
                            }}
                            disabled={isBusy}
                            className="absolute top-1/2 right-2 -translate-y-1/2 p-1 text-white/70 hover:text-white hover:bg-white/10 rounded-full transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            aria-label={`Preview voice ${voice.name}`}
                          >
                            {previewingVoice === voice.name ? (
                              <Spinner />
                            ) : (
                              <PlayIcon className="w-5 h-5" />
                            )}
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>

                  <div>
                    <h3 className="text-sm font-medium text-gray-300 mb-3">Customize Voice</h3>
                    <div className="space-y-4 bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                       {/* Style Prompt Control */}
                       <div>
                        <div className="flex justify-between items-center mb-2">
                          <label htmlFor="style-prompt-input" className="text-sm font-medium text-gray-300">
                             Style Prompt
                          </label>
                           <button 
                             onClick={() => setStylePrompt('')} 
                             className="text-xs text-gray-400 hover:text-white disabled:opacity-50" 
                             disabled={isBusy}
                             aria-label="Clear style prompt"
                           >
                             Clear
                           </button>
                        </div>
                        <div className="flex flex-wrap gap-2 mb-2">
                            {STYLE_PRESETS.map((preset) => (
                                <button
                                    key={preset.name}
                                    onClick={() => setStylePrompt(preset.prompt)}
                                    disabled={isBusy}
                                    className={`px-3 py-1 text-sm rounded-full border-2 transition-colors
                                        ${stylePrompt === preset.prompt
                                            ? 'bg-purple-600 border-purple-500 text-white'
                                            : 'bg-gray-700 border-gray-600 hover:bg-gray-600'
                                        }
                                        ${isBusy ? 'cursor-not-allowed opacity-60' : ''}`
                                    }
                                    aria-pressed={stylePrompt === preset.prompt}
                                >
                                    {preset.name}
                                </button>
                            ))}
                        </div>
                        <input
                           id="style-prompt-input"
                           type="text"
                           value={stylePrompt}
                           onChange={(e) => setStylePrompt(e.target.value)}
                           placeholder="Select a preset or type a custom style..."
                           disabled={isBusy}
                           className="w-full p-2 bg-gray-800 border border-gray-600 rounded-lg focus:ring-1 focus:ring-purple-500 focus:border-purple-500 transition-shadow duration-200 text-gray-200"
                           aria-label="Style prompt for voice performance"
                         />
                      </div>
                      {/* Pitch Control */}
                      <div>
                        <div className="flex justify-between items-center mb-1">
                          <label htmlFor="pitch-slider" className="text-sm font-medium text-gray-300">
                             Pitch
                          </label>
                           <button 
                             onClick={() => setPitch(0.0)} 
                             className="text-xs text-gray-400 hover:text-white disabled:opacity-50" 
                             disabled={isBusy}
                             aria-label="Reset pitch"
                           >
                             Reset
                           </button>
                        </div>
                        <div className="flex items-center gap-3">
                          <input
                             id="pitch-slider"
                             type="range"
                             min="-20"
                             max="20"
                             step="0.1"
                             value={pitch}
                             onChange={(e) => setPitch(parseFloat(e.target.value))}
                             disabled={isBusy}
                             className="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer accent-purple-500"
                             aria-label="Adjust voice pitch"
                           ></input>
                          <span className="text-sm font-mono text-gray-400 w-12 text-center bg-gray-800 px-2 py-0.5 rounded">
                            {pitch.toFixed(1)}
                          </span>
                        </div>
                      </div>
                      {/* Speaking Rate Control */}
                      <div>
                        <div className="flex justify-between items-center mb-1">
                           <label htmlFor="rate-slider" className="text-sm font-medium text-gray-300">
                             Speaking Rate
                           </label>
                           <button 
                             onClick={() => setSpeakingRate(1.0)} 
                             className="text-xs text-gray-400 hover:text-white disabled:opacity-50" 
                             disabled={isBusy}
                             aria-label="Reset speaking rate"
                           >
                             Reset
                           </button>
                        </div>
                        <div className="flex items-center gap-3">
                           <input
                             id="rate-slider"
                             type="range"
                             min="0.25"
                             max="4.0"
                             step="0.05"
                             value={speakingRate}
                             onChange={(e) => setSpeakingRate(parseFloat(e.target.value))}
                             disabled={isBusy}
                             className="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer accent-purple-500"
                             aria-label="Adjust voice speaking rate"
                           ></input>
                           <span className="text-sm font-mono text-gray-400 w-12 text-center bg-gray-800 px-2 py-0.5 rounded">
                            {speakingRate.toFixed(2)}x
                          </span>
                        </div>
                      </div>
                      {/* Volume Gain Control */}
                      <div>
                        <div className="flex justify-between items-center mb-1">
                           <label htmlFor="volume-slider" className="text-sm font-medium text-gray-300">
                             Volume Gain (dB)
                           </label>
                           <button 
                             onClick={() => setVolumeGain(0.0)} 
                             className="text-xs text-gray-400 hover:text-white disabled:opacity-50" 
                             disabled={isBusy}
                             aria-label="Reset volume gain"
                           >
                             Reset
                           </button>
                        </div>
                        <div className="flex items-center gap-3">
                           <input
                             id="volume-slider"
                             type="range"
                             min="-20"
                             max="20"
                             step="0.1"
                             value={volumeGain}
                             onChange={(e) => setVolumeGain(parseFloat(e.target.value))}
                             disabled={isBusy}
                             className="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer accent-purple-500"
                             aria-label="Adjust voice volume gain"
                           ></input>
                           <span className="text-sm font-mono text-gray-400 w-12 text-center bg-gray-800 px-2 py-0.5 rounded">
                             {volumeGain.toFixed(1)}
                           </span>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  {error && (
                    <div role="alert" className="bg-red-900/50 text-red-300 border border-red-700 rounded-lg p-3 text-sm text-center">
                      <strong>Error:</strong> {error}
                    </div>
                  )}

                  <div className="pt-2">
                    <button
                      onClick={handleGenerate}
                      disabled={isBusy || !text.trim()}
                      className="w-full flex items-center justify-center gap-3 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:scale-100"
                    >
                      {loading ? (
                        <>
                          <Spinner />
                          <span>Generating...</span>
                        </>
                      ) : (
                        <>
                          <GeminiLogo className="w-6 h-6" />
                          <span>{audioBuffer ? 'Re-generate Audio' : 'Generate Audio'}</span>
                        </>
                      )}
                    </button>
                  </div>

                  {audioBuffer && !loading && (
                    <div className="space-y-4 pt-4 border-t border-gray-700">
                        <div className="flex items-center gap-3">
                            <span className="text-xs font-mono text-gray-400">{formatTime(playbackTime)}</span>
                            <div className="w-full bg-gray-700 rounded-full h-2">
                                <div 
                                    className="bg-purple-500 h-2 rounded-full" 
                                    style={{ width: `${(playbackTime / duration) * 100}%` }}
                                ></div>
                            </div>
                            <span className="text-xs font-mono text-gray-400">{formatTime(duration)}</span>
                        </div>
                      
                        <div className="flex items-center justify-center gap-4">
                            <button
                                onClick={() => handleSeek(-5)}
                                className="p-2 text-gray-300 hover:text-white bg-gray-700 hover:bg-gray-600 rounded-full transition-colors"
                                aria-label="Rewind 5 seconds"
                            >
                                <RewindIcon className="w-6 h-6"/>
                            </button>
                            <button
                              onClick={handleTogglePlay}
                              disabled={isBusy}
                              className="p-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-full shadow-lg transition-colors duration-200"
                              aria-label={isPlaying ? 'Stop audio' : 'Play generated audio'}
                            >
                              {isPlaying ? <StopIcon className="w-8 h-8"/> : <PlayIcon className="w-8 h-8"/>}
                            </button>
                            <button
                                onClick={() => handleSeek(5)}
                                className="p-2 text-gray-300 hover:text-white bg-gray-700 hover:bg-gray-600 rounded-full transition-colors"
                                aria-label="Fast-forward 5 seconds"
                            >
                                <ForwardIcon className="w-6 h-6"/>
                            </button>

                            <div className="flex-grow"></div>

                            <button
                                onClick={handleDownload}
                                className="flex items-center justify-center gap-2 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-colors duration-200"
                                aria-label="Download generated audio"
                            >
                                <DownloadIcon className="w-5 h-5" />
                                <span>Download</span>
                            </button>
                        </div>
                    </div>
                  )}
                </div>
              </main>

              <footer className="text-center mt-8 text-gray-500 text-sm">
                <p>Powered by the Google Gemini API. Created with React & Tailwind CSS.</p>
              </footer>
            </div>
          </div>
        );
      };

      // --- Start of index.tsx ---
      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }

      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
  <script type="module" src="/index.tsx"></script>
</body>
</html>
